<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Henderson Family Activities Map</title>
  <style>
    :root{--primary:#fd7e14;--accent:#20c997;--bg:#f8f9fa}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;background:#fff;color:#111}
    header{padding:14px 18px;background:linear-gradient(135deg,var(--primary),#ff9800);color:#fff}
    header h1{margin:0;font-size:18px;font-weight:700}
    .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;min-height:100vh}
    .panel{padding:14px;background:var(--bg);border-right:1px solid #e5e7eb}
    .panel h2{font-size:16px;margin:0 0 8px}
    .panel .sub{font-size:12px;color:#555;margin:0 0 10px}
    .pill{display:flex;align-items:center;gap:8px;border:1px solid #cbd5e1;border-radius:999px;padding:8px 12px;background:#fff;margin:6px 0;font-size:13px}
    .pill input{accent-color:var(--primary)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 12px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.small{padding:6px 9px;font-size:12px}
    .group{border:1px solid #e5e7eb;border-radius:10px;background:#fff;padding:10px;margin:12px 0}
    .note{font-size:12px;color:#667085;line-height:1.4}
    #map{width:100%;height:100vh;min-height:640px}
    .divider{height:1px;background:#e5e7eb;margin:12px 0}
    .badge{display:inline-block;background:#fff7ed;color:#7c2d12;border:1px solid #fde68a;padding:2px 8px;border-radius:999px;font-size:11px;margin-left:6px}
    footer{padding:10px 14px;font-size:12px;color:#6b7280;border-top:1px solid #eee}
  </style>
</head>
<body>
<header>
  <h1>üéÆ Henderson Family Activities Map</h1>
</header>
<div class="wrap">
  <aside class="panel">
    <h2>Find activities</h2>
    <p class="sub">Toggle categories and search the current map area.</p>

    <div class="group">
      <label class="pill"><input type="checkbox" id="parks" checked> Parks</label>
      <label class="pill"><input type="checkbox" id="playgrounds" checked> Playgrounds</label>
      <label class="pill"><input type="checkbox" id="aquatics" checked> Aquatic Centers & Pools</label>
      <label class="pill"><input type="checkbox" id="rec" checked> Recreation Centers</label>
      <label class="pill"><input type="checkbox" id="libraries" checked> Libraries</label>
      <label class="pill"><input type="checkbox" id="skate" checked> Skateparks</label>
      <label class="pill"><input type="checkbox" id="sports" checked> Sports Fields (soccer/baseball)</label>
      <div class="divider"></div>
      <div class="row">
        <button id="searchAreaBtn" class="btn primary">üîé Search this area</button>
        <button id="myLocBtn" class="btn small">üìç My location</button>
        <button id="clearBtn" class="btn small">‚ôªÔ∏è Clear</button>
      </div>
    </div>

    <div class="group">
      <h2>Share & export</h2>
      <div class="row">
        <button id="shareBtn" class="btn small">üîó Copy link</button>
        <span id="shareStatus" class="badge" style="display:none">Copied</span>
        <button id="exportBtn" class="btn small">‚¨áÔ∏è Export list (CSV)</button>
      </div>
      <p class="note">Link preserves the map view and selected categories.</p>
    </div>

    <div class="group">
      <h2>Tip</h2>
      <p class="note">Click a marker for directions or to open a list of nearby family restaurants.</p>
    </div>
  </aside>

  <main id="map"></main>
</div>

<footer>
  <div>Data source: Google Maps Places. Always verify hours/requirements before visiting.</div>
</footer>

<script>
  const DEFAULT_CENTER = {lat: 36.0395, lng: -114.9817};
  const DEFAULT_ZOOM = 12;
  const params = new URLSearchParams(location.hash.slice(1) || location.search.slice(1));

  let map, placesService;
  let markers = [];
  let clusterer;

  const catDefs = {
    parks:      { type:'park',              keyword:''            , color:'#34a853' },
    playgrounds:{ type:'park',              keyword:'playground'  , color:'#0ea5e9' },
    aquatics:   { type:'establishment',     keyword:'aquatic center OR pool', color:'#ef4444' },
    rec:        { type:'establishment',     keyword:'recreation center',      color:'#a855f7' },
    libraries:  { type:'library',           keyword:''            , color:'#f59e0b' },
    skate:      { type:'park',              keyword:'skatepark OR skate park' , color:'#22c55e' },
    sports:     { type:'park',              keyword:'soccer field OR baseball field', color:'#10b981' }
  };

  function markerIcon(color) {
    return {
      url: `https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|${color.replace('#','')}`,
      scaledSize: new google.maps.Size(21,34)
    };
  }

  function addMarker(place, color) {
    const m = new google.maps.Marker({
      position: place.geometry.location,
      map,
      icon: markerIcon(color),
      title: place.name
    });
    const gmapsLink = `https://www.google.com/maps/place/?q=place_id:${place.place_id}`;
    const foodLink = `https://www.google.com/maps/search/${encodeURIComponent('family restaurants near ' + place.name + ' ' + (place.vicinity||''))}`;
    const content = `
      <div style="font-family:system-ui,Roboto,Arial,sans-serif;max-width:260px">
        <div style="font-weight:700;margin-bottom:4px">${place.name}</div>
        <div style="font-size:12px;color:#444;margin-bottom:6px">${place.vicinity||''}</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <a target="_blank" href="${gmapsLink}" style="text-decoration:none;padding:6px 8px;border:1px solid #ddd;border-radius:6px">View in Maps</a>
          <a target="_blank" href="${foodLink}" style="text-decoration:none;padding:6px 8px;border:1px solid #ddd;border-radius:6px">Eat nearby</a>
        </div>
      </div>
    `;
    const iw = new google.maps.InfoWindow({content});
    m.addListener('click',()=>iw.open(map,m));
    markers.push(m);
  }

  function clearMarkers() {
    if (clusterer) clusterer.clearMarkers();
    markers.forEach(m=>m.setMap(null));
    markers = [];
  }

  function buildShare() {
    const center = map.getCenter();
    const z = map.getZoom();
    const on = Object.keys(catDefs).filter(id=>document.getElementById(id).checked).join(',');
    const p = new URLSearchParams({ lat:center.lat().toFixed(6), lng:center.lng().toFixed(6), z, on });
    return location.href.split('#')[0] + '#' + p.toString();
  }

  function copyShare() {
    const url = buildShare();
    navigator.clipboard.writeText(url).then(()=>{
      const badge = document.getElementById('shareStatus');
      badge.style.display='inline-block';
      setTimeout(()=>badge.style.display='none',1500);
    });
  }

  function exportCSV() {
    if (!markers.length) return alert('Run a search first');
    const header = 'Name,Address,Lat,Lng,Google Maps URL\n';
    let rows = '';
    const bounds = map.getBounds();
    markers.forEach(m=>{
      if (!bounds || bounds.contains(m.getPosition())) {
        const lat = m.getPosition().lat();
        const lng = m.getPosition().lng();
        const name = '"' + (m.getTitle()||'').replace(/"/g,'""') + '"';
        const link = `https://www.google.com/maps?q=${lat},${lng}`;
        rows += `${name},,,${lat},${lng},${link}\n`;
      }
    });
    const blob = new Blob([header + rows], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'henderson-family-activities.csv';
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  function searchCategory(def){
    const bounds = map.getBounds();
    if (!bounds) return;
    const request = {
      bounds,
      type: def.type,
      keyword: def.keyword
    };
    return new Promise(resolve=>{
      placesService.nearbySearch(request,(results,status,pagination)=>{
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results) {
          resolve([]);
          return;
        }
        results.forEach(p=>addMarker(p, def.color));
        if (pagination && pagination.hasNextPage) {
          setTimeout(()=>pagination.nextPage(), 1000);
        }
        resolve(results);
      });
    });
  }

  async function searchThisArea(){
    clearMarkers();
    const tasks = [];
    Object.entries(catDefs).forEach(([id,def])=>{
      if (document.getElementById(id).checked) tasks.push(searchCategory(def));
    });
    await Promise.all(tasks);
    if (markers.length && window.MarkerClusterer) {
      clusterer = new MarkerClusterer({ map, markers });
    }
  }

  window.initActivitiesMap = () => {
    const lat = parseFloat(params.get('lat')) || DEFAULT_CENTER.lat;
    const lng = parseFloat(params.get('lng')) || DEFAULT_CENTER.lng;
    const z = parseInt(params.get('z') || DEFAULT_ZOOM, 10);
    const on = (params.get('on') || '').split(',').filter(Boolean);
    map = new google.maps.Map(document.getElementById('map'), { center:{lat,lng}, zoom:z, mapId:'DEMO_MAP_ID' });
    placesService = new google.maps.places.PlacesService(map);

    if (on.length) {
      Object.keys(catDefs).forEach(id=>document.getElementById(id).checked = on.includes(id));
    }

    document.getElementById('searchAreaBtn').addEventListener('click', searchThisArea);
    document.getElementById('clearBtn').addEventListener('click', clearMarkers);
    document.getElementById('myLocBtn').addEventListener('click', ()=>{
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition((pos)=>{
        const loc = {lat:pos.coords.latitude,lng:pos.coords.longitude};
        map.panTo(loc); map.setZoom(14);
      }, ()=>alert('Could not get your location'));
    });
    document.getElementById('shareBtn').addEventListener('click', copyShare);
    document.getElementById('exportBtn').addEventListener('click', exportCSV);

    map.addListener('idle', ()=>{
      const url = buildShare();
      history.replaceState(null,'',url);
    });

    searchThisArea();
  }
</script>
<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initActivitiesMap" async defer></script>
</body>
</html>
